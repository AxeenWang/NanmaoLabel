# Delta Spec: ListView 選取後標籤預覽未顯示

| 項目 | 內容 |
|------|------|
| 文件版本 | v1.0 |
| 建立日期 | 2026-02-01 |
| 關聯規格 | `.dao/raw_spec.md` v2.5 |
| 狀態 | **待實作** |
| 類型 | Bug Fix / 功能補齊 |

---

## 1. 問題定義

### 1.1 目前實際行為

當使用者在「標籤列印」分頁的 ListView 中點選任一項目時：

- ListView 項目正確顯示選取狀態（藍色高亮）
- 左側標籤預覽區**維持空白**，未顯示任何標籤內容
- 狀態列顯示「共 10 筆資料」，確認資料已載入

**截圖佐證**：`.dao/沒有顯示標籤.local.png`

### 1.2 預期行為（依據 raw_spec.md）

| 規格來源 | 預期行為 |
|----------|----------|
| §2.1 系統架構圖 | `ListView 資料清單 → [選取] → 標籤預覽` |
| §3.1 F-06 | 標籤預覽：畫面即時顯示標籤樣式，含文字與條碼 |
| §8.4 操作流程 | `單擊項目 → 左側即時預覽標籤` |
| §8.4 元件說明 | 單擊 ListView 項目 → 左側預覽區即時顯示該筆資料的標籤 |
| TC-06 測試案例 | 單擊 ListView 項目 → 上方預覽區顯示該筆標籤 |
| A-06 驗收條件 | 單擊 ListView 項目即時預覽標籤 |

### 1.3 問題根因分析

經程式碼審查，問題出在**渲染層未實作**：

| 層級 | 狀態 | 說明 |
|------|------|------|
| 資料綁定層 | ✅ 已完成 | `ListView.SelectedItem` 雙向綁定至 `ViewModel.SelectedRecord` |
| 屬性通知層 | ✅ 已完成 | `[NotifyPropertyChangedFor(nameof(PreviewCommands))]` 正確連鎖通知 |
| 渲染指令層 | ✅ 已完成 | `PreviewCommands` getter 呼叫 `ILabelRenderer.Render()` 產生渲染指令 |
| 條件顯示層 | ✅ 已完成 | `HasSelectedRecord` 控制預覽區與空白提示的切換 |
| **Canvas 渲染層** | ❌ **未實作** | `PreviewCanvas` 未訂閱 `PreviewCommands` 變更，未執行繪製邏輯 |

---

## 2. 標籤顯示的觸發時機

### 2.1 觸發條件

標籤預覽應在以下事件發生時更新：

| 事件 | 觸發來源 | 預期行為 |
|------|----------|----------|
| SelectionChanged | 使用者單擊 ListView 項目 | 渲染選取項目的標籤至預覽區 |
| TemplateChanged | 使用者切換標籤格式下拉選單 | 以新格式重新渲染當前選取項目 |
| DataReloaded | 資料管理分頁儲存後同步 | 若選取項目資料有變更，重新渲染 |

### 2.2 事件流程圖

```
┌─────────────────────────────────────────────────────────────────┐
│ 使用者單擊 ListView 項目                                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ WPF Binding 更新 ViewModel.SelectedRecord                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ CommunityToolkit.Mvvm 觸發 PropertyChanged:                      │
│   - SelectedRecord                                               │
│   - HasSelectedRecord                                            │
│   - PreviewCommands ← 連鎖通知                                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ View 層監聽 PreviewCommands 變更                                 │
│   → 清空 PreviewCanvas                                           │
│   → 遍歷 RenderCommand 集合                                      │
│   → 依指令類型繪製 Text / Barcode / QRCode                       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ PreviewCanvas 顯示完整標籤內容                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 標籤資料來源與顯示條件

### 3.1 資料來源

| 項目 | 來源 | 說明 |
|------|------|------|
| 標籤格式定義 | `ViewModel.SelectedTemplate` | 來自 `BuiltInTemplates`（QW075551-1 / QW075551-2） |
| 交易資料 | `ViewModel.SelectedRecord` | 來自 `data.json`，透過 ListView 選取 |
| 渲染指令 | `ILabelRenderer.Render(template, record)` | 依格式定義與資料產生繪圖指令 |

### 3.2 顯示條件判斷邏輯

```
IF SelectedRecord == null OR SelectedTemplate == null THEN
    顯示空白狀態提示（「請先匯入資料或選取資料項目」）
ELSE
    執行渲染流程：
    1. 取得 PreviewCommands = LabelRenderer.Render(template, record)
    2. 清空 PreviewCanvas.Children
    3. 遍歷 PreviewCommands：
       - TextCommand → 繪製 TextBlock
       - BarcodeCommand → 繪製 Image (Code 128)
       - QRCodeCommand → 繪製 Image (QR Code)
    4. 顯示標籤預覽區（隱藏空白提示）
END IF
```

### 3.3 座標轉換規範

依據 `raw_spec.md` §13.1，預覽區座標轉換須遵循：

| 項目 | 規格 |
|------|------|
| 標籤實際尺寸 | 100mm × 60mm |
| 預覽 Canvas 尺寸 | 400px × 240px（4:1 縮放比） |
| 座標轉換公式 | `px = mm × 4` |
| 字型縮放 | `previewFontSize = specFontSize × 4 / 2.83465`（pt 轉 px 再縮放） |

---

## 4. 空值與邊界情況處理

### 4.1 標籤為空 / null / 尚未載入時的顯示規則

| 情境 | 顯示內容 | UI 行為 |
|------|----------|---------|
| `SelectedRecord == null` | 空白狀態提示 | 顯示「📋 請先匯入資料或選取資料項目」 |
| `SelectedTemplate == null` | 空白狀態提示 | 同上（理論上不應發生，因有預設值） |
| `PreviewCommands == null` | 空白狀態提示 | 同上 |
| `PreviewCommands.Count == 0` | 空白標籤框 | 顯示白色標籤背景，無內容 |
| 渲染過程發生例外 | 錯誤提示 | 顯示「⚠️ 標籤渲染失敗」並記錄錯誤 |

### 4.2 欄位資料缺失時的處理

依據 `raw_spec.md` §3.3：

| 情境 | 處理方式 |
|------|----------|
| 必要欄位缺失 | 彈出警告：「資料缺失：{欄位名稱}，無法產生標籤」 |
| 非必要欄位缺失 | 該欄位顯示空白，不影響其他欄位渲染 |

---

## 5. 切換 ListView 項目時的更新規則

### 5.1 切換行為規範

| 動作 | 預期結果 |
|------|----------|
| 從項目 A 切換至項目 B | 預覽區立即更新為項目 B 的標籤內容 |
| 從有選取切換至無選取（按 Esc 或點空白處） | 預覽區顯示空白狀態提示 |
| 快速連續切換多個項目 | 每次切換皆觸發渲染，最終顯示最後選取的項目 |
| 切換至相同項目（重複點擊） | 不重新渲染（效能優化，可選） |

### 5.2 渲染效能考量

| 項目 | 規範 |
|------|------|
| 渲染時機 | 同步執行（選取後立即渲染） |
| 渲染延遲 | 應在 100ms 內完成（使用者可感知的即時性） |
| 快取策略 | POC 階段不實作快取，每次選取皆重新渲染 |

---

## 6. 驗收條件（Acceptance Criteria）

### 6.1 功能驗收

| AC# | 驗收項目 | 驗收方式 |
|-----|----------|----------|
| AC-01 | 單擊 ListView 任一項目，左側預覽區顯示該筆標籤 | 目視檢查 |
| AC-02 | 標籤預覽包含所有定義欄位（文字、條碼、QR Code） | 目視對照規格 |
| AC-03 | 切換標籤格式（QW075551-1 ↔ QW075551-2），預覽區即時更新 | 目視檢查 |
| AC-04 | 切換不同 ListView 項目，預覽區正確更新為新項目內容 | 目視檢查 |
| AC-05 | 無選取項目時，顯示空白狀態提示文字 | 目視檢查 |
| AC-06 | 預覽區版面與 PDF 輸出一致（誤差 ≤ ±0.5mm） | 對照 PDF 輸出 |

### 6.2 測試案例對應

| 測試案例 | 對應 raw_spec.md |
|----------|------------------|
| AC-01 | TC-06：單擊預覽 |
| AC-02 | A-04：標籤預覽 |
| AC-03 | §8.4：切換標籤格式 → 預覽區即時更新為新格式 |
| AC-06 | A-10：PDF 版面與預覽一致 |

### 6.3 負面測試

| 測試項目 | 預期結果 |
|----------|----------|
| 程式啟動時無 data.json | 預覽區顯示空白狀態提示 |
| data.json 為空陣列 | 預覽區顯示空白狀態提示 |
| 選取項目後刪除 data.json | 預覽維持顯示（記憶體資料） |

---

## 7. 實作建議（非規格，僅供參考）

### 7.1 建議實作位置

| 檔案 | 修改內容 |
|------|----------|
| `LabelPrintView.xaml.cs` | 新增 `PreviewCommands` 變更監聽與 Canvas 渲染邏輯 |

### 7.2 建議實作方式

1. 在 `LabelPrintView` 的 `DataContextChanged` 或 `Loaded` 事件中訂閱 ViewModel 的 `PropertyChanged`
2. 當 `PreviewCommands` 變更時，執行 `RenderPreview()` 方法
3. `RenderPreview()` 清空 `PreviewCanvas.Children`，遍歷指令集合繪製元素

---

## 8. 變更歷程

| 版本 | 日期 | 變更內容 | 作者 |
|------|------|----------|------|
| v1.0 | 2026-02-01 | 初版建立：問題定義、觸發時機、資料來源、邊界處理、驗收條件 | Claude |
